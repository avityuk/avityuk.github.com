<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"  />
<meta name="description" content="Andrey Vityuk's Dev Blog" />
<meta name="keywords" content="code,software,development" />
<meta name="author" content="Andrey Vityuk" />
<link rel="stylesheet" type="text/css" href="/stylesheets/default.css" />
<link rel="stylesheet" type="text/css" href="/stylesheets/syntax.css" />

<link rel="canonical" href="http://avityuk.github.com/2008/12/blog-post.html">

<link rel="alternate" type="application/atom+xml" href="http://avityuk.github.com/atom.xml" />

<title>Подмена Синглтонов</title>
</head>
<body>
	<div id="header">
	</div>

	<div id="main">
		<div id="content">
			<div id="post">
	<h3 class="post-title"><a href="/2008/12/blog-post.html" rel="bookmark">Подмена Синглтонов</a></h3>
	
	<div id="poster">
		<img src="http://2.bp.blogspot.com/_MzPDIAgS1ow/SYWiiNXWgDI/AAAAAAAAJr4/rMPEwUK1HsM/s320/sngleton.jpg" width="320px" height="234px" />
	</div>
	
	<p>Недавно мне в очередной раз пришлось работать с кодом, полученным в наследство. И я, как честный преверженец <a href="http://en.wikipedia.org/wiki/Test-driven_development">TDD</a>, решил предже всего написать тесты на уже существующий класс. К своему огорчению сразу же обнаружил в коде вызов следующего вида: <code>IdGenerator.getInstance()</code>. Да, это он самый, "любимый" нами <a href="http://ru.wikipedia.org/wiki/%D0%9E%D0%B4%D0%B8%D0%BD%D0%BE%D1%87%D0%BA%D0%B0_%28%D1%88%D0%B0%D0%B1%D0%BB%D0%BE%D0%BD_%D0%BF%D1%80%D0%BE%D0%B5%D0%BA%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F%29">синглтон</a>.</p>

<p><em>UserService.java:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">example</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserService</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="n">User</span> <span class="nf">createUser</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">IdGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">().</span><span class="na">generateId</span><span class="o">(</span><span class="n">name</span><span class="o">);</span>

    <span class="k">return</span> <span class="k">new</span> <span class="nf">User</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">name</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><em>User.java:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">example</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">User</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>

  <span class="kd">public</span> <span class="nf">User</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
    <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getName</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">name</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Большинство разработчиков не любят синглтоны, как минимум из-за ряда следующих недостатков:</p>

<ul>
  <li>Путаница в зависимостях между классами. Синглтоны в коде, в основном, появляются неожиданно и при беглом просмотре их заметить сложно.</li>
  <li>Усложняют последующие изменения в системе. При использовании синглтона будет гораздо сложнее вынести его API в интерфейс и иметь несколько реализаций для разных клиентов.</li>
  <li>Препятствуют тестируемости кода.</li>
</ul>

<p>Дабы не вдаваться в подробности и не ввязываться в религиозные споры замечу сразу советую почитать статью: <a href="http://code.google.com/p/google-singleton-detector/wiki/WhySingletonsAreControversial">"Why Singletons Are Controversial"</a>.  </p>

<p>В связи с тем, что живем мы в далеком от идеала мире и у нас не всегда есть возможность что-то изменить, ингода нам приходится иметь дело с кодом, который нам нельзя сильно рафакторить по определенным причинам. Поэтому, вернемся все-таки к ситуации когда у нас есть синглтон (<code>IdGenerator</code>) и класс (<code>UserService</code>), который его использует.  </p>

<p><em>IdGenerator.java:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Random</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">IdGenerator</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="n">IdGenerator</span> <span class="n">instance</span> <span class="o">=</span> <span class="k">new</span> <span class="n">IdGenerator</span><span class="o">();</span>

  <span class="kd">private</span> <span class="nf">IdGenerator</span><span class="o">()</span> <span class="o">{</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="n">IdGenerator</span> <span class="nf">getInstance</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">instance</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">generateId</span><span class="o">(</span><span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="k">new</span> <span class="nf">Random</span><span class="o">().</span><span class="na">nextInt</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>И теперь попробуем написать тест к классу (<code>UserService</code>), зависящему от синглтона (<code>IdGenerator</code>).  </p>

<p><em>UserServiceTest:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.After</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Before</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceTest</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">UserService</span> <span class="n">service</span><span class="o">;</span>

  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserService</span><span class="o">();</span>
  <span class="o">}</span>

  <span class="nd">@After</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tearDown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">service</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUser</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">);</span>

    <span class="n">assertNotNull</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="c1">// assertEquals(???, user.getId());</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>А вот далее попытаемся проверить значение ожидаемого id пользователя: <code>assertEquals(???, user.getId())</code>. Согласитесь, ситуация не из простых? К тому же, допустим, что <code>IdGenerator</code> использует для генерации id не простой рендомайзер, а полноценную БД. В голову приходят только мысли про <a href="http://en.wikipedia.org/wiki/Mock_object">Mock Objects</a>. Но тут так просто не выкрутиться с любимым <a href="http://www.easymock.org/">EasyMock</a> или <a href="http://www.jmock.org/">JMock</a>, потому как не один из них не умеет подменять статические методы. И тут мы вспоминаем про третий пункт за что мы так не любим синглтоны.  </p>

<p>Немного подумав я решил, что все-таки должен быть способ заменить вызов статического метода в процессе тестирования. А уже в подмененном методе <code>getInstance</code> вернуть mock <code>IdGenerator</code>.  </p>

<p>Давайте рассмотрим, что для этого нужно:</p>

<ol>
  <li>Иметь возможность при загрузке класса выполнить его модификаци. А именно подсунуть ему свою реализацию метода <code>getInstance</code>.</li>
  <li>Создать наследника final класса <code>IdGenerator</code>.</li>
</ol>

<p>На первый взгляд может показаться, что это невозможно. После недолгих поисков я наткнулся на <a href="https://jmockit.dev.java.net/">JMockit</a>, который позволяет изменять в runtime статические методы классов и даже конструкторы. Но основным его недостатком является необходимость в дополнительных параметрах запуска Java. И так, еще немного поискав я нашел другое средство: <a href="http://code.google.com/p/powermock/">PowerMock</a>. Список его возможностей меня сразу же убедил в том, что префикс "Power" в его названии действительно оправдан.  </p>

<p>Вот, небольшой перечень того, что <strong>PowerMock</strong> умеет делать:</p>

<ul>
  <li>Mocking статических методов</li>
  <li>Mocking final методов и классов</li>
  <li>Mocking private методов</li>
  <li>Обход инкапсуляции</li>
  <li>Mock конструкторов</li>
  <li>Подавлять нежелательно поведение</li>
</ul>

<p>Больше всего порадовала тесная интеграция с <strong>EasyMock</strong>.  </p>

<p>Вот, собственно, и сам тест для упрямого <strong>UserService</strong>.  </p>

<p><em>UserServiceTest:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">example</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">EasyMock</span><span class="o">.</span><span class="na">expect</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertEquals</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">junit</span><span class="o">.</span><span class="na">Assert</span><span class="o">.</span><span class="na">assertNotNull</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">powermock</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">PowerMock</span><span class="o">.</span><span class="na">createMock</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">powermock</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">PowerMock</span><span class="o">.</span><span class="na">mockStatic</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">powermock</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">PowerMock</span><span class="o">.</span><span class="na">replayAll</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">static</span> <span class="n">org</span><span class="o">.</span><span class="na">powermock</span><span class="o">.</span><span class="na">api</span><span class="o">.</span><span class="na">easymock</span><span class="o">.</span><span class="na">PowerMock</span><span class="o">.</span><span class="na">verifyAll</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.After</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Before</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.junit.runner.RunWith</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.powermock.core.classloader.annotations.PrepareForTest</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.powermock.modules.junit4.PowerMockRunner</span><span class="o">;</span>

<span class="nd">@PrepareForTest</span><span class="o">(</span><span class="n">IdGenerator</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@RunWith</span><span class="o">(</span><span class="n">PowerMockRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserServiceTest</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="n">UserService</span> <span class="n">service</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">IdGenerator</span> <span class="n">mockIdGenerator</span><span class="o">;</span>

  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">service</span> <span class="o">=</span> <span class="k">new</span> <span class="n">UserService</span><span class="o">();</span>
    <span class="n">mockIdGenerator</span> <span class="o">=</span> <span class="n">createMock</span><span class="o">(</span><span class="n">IdGenerator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="n">mockStatic</span><span class="o">(</span><span class="n">IdGenerator</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@After</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">tearDown</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
    <span class="n">service</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="n">mockIdGenerator</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">createUser</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">expect</span><span class="o">(</span><span class="n">IdGenerator</span><span class="o">.</span><span class="na">getInstance</span><span class="o">()).</span><span class="na">andReturn</span><span class="o">(</span><span class="n">mockIdGenerator</span><span class="o">);</span>
    <span class="n">expect</span><span class="o">(</span><span class="n">mockIdGenerator</span><span class="o">.</span><span class="na">generateId</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">)).</span><span class="na">andReturn</span><span class="o">(</span><span class="mi">1234</span><span class="o">);</span>
    <span class="n">replayAll</span><span class="o">();</span>

    <span class="n">User</span> <span class="n">user</span> <span class="o">=</span> <span class="n">service</span><span class="o">.</span><span class="na">createUser</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">);</span>

    <span class="n">assertNotNull</span><span class="o">(</span><span class="n">user</span><span class="o">);</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="mi">1234</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getId</span><span class="o">());</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;john&quot;</span><span class="o">,</span> <span class="n">user</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>

    <span class="n">verifyAll</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Кстати, это же решение подходит для тестирования кода, который зависит от системных классов. Например, можно подменить вызов метода: <code>System.currentTimeMillis()</code>.  </p>

<p>На этом буду закругляться. Единственное, хочу упомянуть, что в любом случае следует несколько раз подумать, прежде чем оставлять вызов синглтона в коде. Тех же требований можно достичь гораздо меньшей ценой с помощью <a href="http://en.wikipedia.org/wiki/Dependency_injection">Dependency Injection</a> и различных фреймворков вроде <a href="http://www.springsource.org/">Spring</a> и <a href="http://code.google.com/p/google-guice/">Guice</a>.</p>



	<div class="post-meta">
		<span class="date">17 Dec 2008 | </span>
		<span class="tags">
			Tags:
			
				<a href="/tags/java" rel="tag">java, </a>
			
				<a href="/tags/mock" rel="tag">mock, </a>
			
				<a href="/tags/pattern" rel="tag">pattern</a>
			
		</span>
	</div>
</div>

		</div>
		<div id="sidebar">
			<div id="tags">
	<h2>Tags</h2>
	<ul>
	
		<li><a href="/tags/compiler" rel="tag">compiler</a> (1)</li>
	
		<li><a href="/tags/bytecode" rel="tag">bytecode</a> (1)</li>
	
		<li><a href="/tags/debugging" rel="tag">debugging</a> (1)</li>
	
		<li><a href="/tags/reflection" rel="tag">reflection</a> (2)</li>
	
		<li><a href="/tags/java" rel="tag">java</a> (7)</li>
	
		<li><a href="/tags/google" rel="tag">google</a> (1)</li>
	
		<li><a href="/tags/sbt" rel="tag">sbt</a> (1)</li>
	
		<li><a href="/tags/factory-method" rel="tag">factory method</a> (1)</li>
	
		<li><a href="/tags/pattern" rel="tag">pattern</a> (2)</li>
	
		<li><a href="/tags/formatting" rel="tag">formatting</a> (1)</li>
	
		<li><a href="/tags/jdbc" rel="tag">jdbc</a> (1)</li>
	
		<li><a href="/tags/appengine" rel="tag">appengine</a> (1)</li>
	
		<li><a href="/tags/error-handling" rel="tag">error handling</a> (1)</li>
	
		<li><a href="/tags/performance" rel="tag">performance</a> (1)</li>
	
		<li><a href="/tags/testing" rel="tag">testing</a> (1)</li>
	
		<li><a href="/tags/generics" rel="tag">generics</a> (1)</li>
	
		<li><a href="/tags/scala" rel="tag">scala</a> (2)</li>
	
		<li><a href="/tags/multithreading" rel="tag">multithreading</a> (1)</li>
	
		<li><a href="/tags/web" rel="tag">web</a> (1)</li>
	
		<li><a href="/tags/logging" rel="tag">logging</a> (2)</li>
	
		<li><a href="/tags/mock" rel="tag">mock</a> (1)</li>
	
	</ul>
</div>

		</div>
		<div style="clear: both;"></div>
	</div>

	<div id="footer">
	</div>
</body>
</html>
