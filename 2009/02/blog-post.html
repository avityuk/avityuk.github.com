<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"  />
<meta name="description" content="Andrey Vityuk's Dev Blog" />
<meta name="keywords" content="code,software,development" />
<meta name="author" content="Andrey Vityuk" />
<link rel="stylesheet" type="text/css" href="/stylesheets/default.css" />
<link rel="stylesheet" type="text/css" href="/stylesheets/syntax.css" />

<link rel="canonical" href="http://avityuk.github.com/2009/02/blog-post.html">

<link rel="alternate" type="application/atom+xml" href="http://avityuk.github.com/atom.xml" />

<title>Чем опасно логирование</title>
</head>
<body>
	<div id="header-wrapper">
		<div id="header">
			<h1><a id="blog-title" href="http://avityuk.github.com">Andrey Vityuk</a></h1>
			Tips and walkthroughs on software development
		</div>
	</div>

	<div id="main-wrapper">
		<div id="main">
			<div id="content">
				<div class="post">
	<h2 class="date-header">Sunday, February 15, 2009</h2>
	<h3 class="post-title"><a href="/2009/02/blog-post.html" rel="bookmark">Чем опасно логирование</a></h3>
	
	<div class="post-image">
		<img src="http://1.bp.blogspot.com/_MzPDIAgS1ow/SY_wAoSR8wI/AAAAAAAAJt4/m0NJppz2yfQ/s320/The_Most_poisonous_frog.jpg" width="320px" height="230px" />
	</div>
	
	<p>Большинство современных приложений не обходится без логирования. Почти каждый разработчик, так или иначе, знаком с тем как это делается. Для Java существует довольно обширный набор библиотек для удобного логирования: <a href="http://logging.apache.org/log4j/1.2/index.html">Log4J</a>, <a href="http://commons.apache.org/logging/">Jakarta Commons Logging</a>, <a href="http://www.slf4j.org/">SLF4J</a>, <a href="http://logback.qos.ch/">Logback</a> и <a href="http://java.sun.com/javase/6/docs/technotes/guides/logging/overview.html">Java Logging API</a> и т.д. </p>

<p>Существующие библиотеки позволяют очень удобно разграничить вывод информации об ошибках, предупреждений, информационных сообщений и отладочной информации. Так же, позволяют настроить предпочитаемую степень логирование непосредственно перед запуском приложения.  </p>

<p>Но, к своему удивлению, я недавно заметил, что большинство разработчиков пользуются логированием неправильно. &ldquo;Что значит неправильно?&rdquo;, - удивитесь Вы.</p>

<!-- more -->

<p>Взглянем, к примеру, на типичную инструкцию для вывода отладочной информации:</p>

<pre><code>log.debug("Processing " + orders.size() + " orders: " + orders);
</code></pre>

<p>Это самый обычный вывод отладочной информации о том, что сейчас начнут обрабатываться определенный список заказов. Давайте разберемся что происходит при логированиее сообщения:</p>

<ol>
  <li>Выполняется преобразование <code>orders.size()</code> в строку.</li>
  <li>Конкатенируется строка <code>"Processing "</code> с преобразованным <code>orders.size()</code>.</li>
  <li>Полученная строка, в свою очередь, конкатенируется с <code>" orders: "</code>.</li>
  <li>Здесь происходит самое страшное: для каждого элемента списка <code>orders</code> вызывается метод <code>toString()</code>.</li>
  <li>Полученная строка добавляется к уже существующей.</li>
  <li>Библиотека логирование проверяет включено-ли логирование для уровня DEBUG.</li>
  <li>Если уровень DEBUG логируется, выполняется запись в журнал лога.</li>
</ol>

<p>Вы только подумайте, что все, кроме последнего пункта выполняются даже при выключенном логировании отладочной информации. Даже, если учитывать то, что компилятор оптимизирует конкатенацию строк и <a href="http://kaioa.com/node/59">заменит ее на StringBuilder</a>, накладные рассходы могут быть просто коллосальными при условии, что список немаленький и объекты в списке имееют перегруженные методы <code>toString()</code>.  </p>

<p>Как же исправить ситуацию? Для этого перечисленные быблиотеки логирования предоставляют метододы вида: <code>is*Enabled()</code>. Приведенная строка будет теперь выглядить следующим образом:</p>

<pre><code>if (log.isDebugEnabled()) {  log.debug("Processing " + orders.size() + " orders: " + orders);}
</code></pre>

<p>Хотя она значительно устрашает код, все же лучше взять за правило использовать данную проверку всегда, когда в строке логирования выводятся какие-либо данные. На моем предыдущем проекте это правило даже было в Code Conventions.  </p>

<p>По личному опыту могу сказать, что люди иногда слишком сильно занимаются оптимизацией производительности, но на такие вещи даже не обращают внимания. Для этого я решил немного протестировать использование различных подходов при логировании с использованием <strong>Log4J</strong>.  </p>

<p>Тест с использованием конкатенации и без дополнительных проверок.</p>

<p><em>TestConcat:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">test</span><span class="o">.</span><span class="na">log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.log4j.Logger</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConcat</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">TestConcat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NUMBER</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ITERATIONS</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">OrderGenerator</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="n">NUMBER</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ITERATIONS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">doWork</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">TimeCounter</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TimeCounter</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ITERATIONS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">doWork</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">counter</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Time taken: &quot;</span> <span class="o">+</span> <span class="n">counter</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doWork</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Processing &quot;</span> <span class="o">+</span> <span class="n">orders</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; orders: &quot;</span> <span class="o">+</span> <span class="n">orders</span><span class="o">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">processedOrders</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>

    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Processed &quot;</span> <span class="o">+</span> <span class="n">orders</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; orders: &quot;</span> <span class="o">+</span> <span class="n">orders</span>
        <span class="o">+</span> <span class="s">&quot; with result: &quot;</span> <span class="o">+</span> <span class="n">processedOrders</span><span class="o">);</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Тест с использованием конкатенации с проверкой уровня логирования.</p>

<p><em>TestConditionalConcat:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">test</span><span class="o">.</span><span class="na">log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.log4j.Logger</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConditionalConcat</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">Logger</span>
      <span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">TestConditionalConcat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NUMBER</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ITERATIONS</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">OrderGenerator</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="n">NUMBER</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ITERATIONS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">doWork</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">TimeCounter</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TimeCounter</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ITERATIONS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">doWork</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">counter</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Time taken: &quot;</span> <span class="o">+</span> <span class="n">counter</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doWork</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Processing &quot;</span> <span class="o">+</span> <span class="n">orders</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; orders: &quot;</span> <span class="o">+</span> <span class="n">orders</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">processedOrders</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">log</span><span class="o">.</span><span class="na">isDebugEnabled</span><span class="o">())</span> <span class="o">{</span>
      <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Processed &quot;</span> <span class="o">+</span> <span class="n">orders</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">+</span> <span class="s">&quot; orders: &quot;</span> <span class="o">+</span> <span class="n">orders</span>
          <span class="o">+</span> <span class="s">&quot; with result: &quot;</span> <span class="o">+</span> <span class="n">processedOrders</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Тест с использованием библиотеки-фасада <a href="http://www.slf4j.org/">SLF4J</a>. Эта библиотека является оберткой для одной из существующих систем логирования (в нашем случае <strong>Log4J</strong>, хотя сам бы я предпочел <strong>Logback</strong>). В нашем случае интересным ее преимуществом будет то, что вместо конкатенации в ней используется концепция упрощенной форматной строки. Такая форма вызова остается достаточно простой и не требует дополнительных проверок уровня в клиентском коде.</p>

<p><em>TestFormat:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">test</span><span class="o">.</span><span class="na">log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.slf4j.Logger</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.slf4j.LoggerFactory</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestFormat</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">Logger</span> <span class="n">log</span> <span class="o">=</span> <span class="n">LoggerFactory</span><span class="o">.</span><span class="na">getLogger</span><span class="o">(</span><span class="n">TestFormat</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">NUMBER</span> <span class="o">=</span> <span class="mi">1000</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">ITERATIONS</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span> <span class="o">=</span> <span class="n">OrderGenerator</span><span class="o">.</span><span class="na">generate</span><span class="o">(</span><span class="n">NUMBER</span><span class="o">);</span>

    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ITERATIONS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">doWork</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">TimeCounter</span> <span class="n">counter</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TimeCounter</span><span class="o">().</span><span class="na">start</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ITERATIONS</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">doWork</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">counter</span><span class="o">.</span><span class="na">stop</span><span class="o">();</span>
    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">&quot;Time taken: &quot;</span> <span class="o">+</span> <span class="n">counter</span><span class="o">.</span><span class="na">get</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">doWork</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Processing {} orders: {}&quot;</span><span class="o">,</span> <span class="n">orders</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">orders</span><span class="o">);</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">processedOrders</span> <span class="o">=</span> <span class="n">OrderProcessor</span><span class="o">.</span><span class="na">process</span><span class="o">(</span><span class="n">orders</span><span class="o">);</span>

    <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">&quot;Processed {} orders: {} with result: {}&quot;</span><span class="o">,</span>
        <span class="k">new</span> <span class="n">Object</span><span class="o">[]</span> <span class="o">{</span> <span class="n">orders</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">orders</span><span class="o">,</span> <span class="n">processedOrders</span> <span class="o">});</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>Ниже следуют используемые в тестах классы.</p>

<p><em>Order.java:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">test</span><span class="o">.</span><span class="na">log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">Order</span> <span class="kd">implements</span> <span class="n">Comparable</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">id</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">customerId</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">Date</span> <span class="n">orderDate</span><span class="o">;</span>
  <span class="kd">private</span> <span class="n">String</span> <span class="n">details</span><span class="o">;</span>

  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setId</span><span class="o">(</span><span class="kt">long</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">getCustomerId</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">customerId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setCustomerId</span><span class="o">(</span><span class="kt">long</span> <span class="n">customerId</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">customerId</span> <span class="o">=</span> <span class="n">customerId</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">Date</span> <span class="nf">getOrderDate</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">orderDate</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setOrderDate</span><span class="o">(</span><span class="n">Date</span> <span class="n">orderDate</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">orderDate</span> <span class="o">=</span> <span class="n">orderDate</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">String</span> <span class="nf">getDetails</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">details</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setDetails</span><span class="o">(</span><span class="n">String</span> <span class="n">details</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">.</span><span class="na">details</span> <span class="o">=</span> <span class="n">details</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">int</span> <span class="nf">compareTo</span><span class="o">(</span><span class="n">Order</span> <span class="n">otherOrder</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">orderDate</span><span class="o">.</span><span class="na">compareTo</span><span class="o">(</span><span class="n">otherOrder</span><span class="o">.</span><span class="na">orderDate</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Override</span>
  <span class="kd">public</span> <span class="n">String</span> <span class="nf">toString</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">StringBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuilder</span><span class="o">();</span>

    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;[&quot;</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;id = &quot;</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, customerId = &quot;</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">customerId</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, orderDate = &quot;</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">orderDate</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;, details = &quot;</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">details</span><span class="o">);</span>
    <span class="n">builder</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="s">&quot;]&quot;</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><em>OrderGenerator.java:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">test</span><span class="o">.</span><span class="na">log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Date</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderGenerator</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">generate</span><span class="o">(</span><span class="kt">int</span> <span class="n">number</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">Orders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;(</span><span class="n">number</span><span class="o">);</span>

    <span class="kt">long</span> <span class="n">date</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">number</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
      <span class="n">Order</span> <span class="n">Order</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Order</span><span class="o">();</span>
      <span class="n">Order</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="mi">1L</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
      <span class="n">Order</span><span class="o">.</span><span class="na">setCustomerId</span><span class="o">(</span><span class="mi">1000000L</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
      <span class="n">Order</span><span class="o">.</span><span class="na">setOrderDate</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="n">date</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">number</span><span class="o">));</span>
      <span class="n">Order</span><span class="o">.</span><span class="na">setDetails</span><span class="o">(</span><span class="s">&quot;Order &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
      <span class="n">Orders</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">Order</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">Orders</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><em>OrderProcessor.java:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">test</span><span class="o">.</span><span class="na">log</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.ArrayList</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.Collections</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderProcessor</span> <span class="o">{</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">process</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">orders</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">List</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;</span> <span class="n">processedOrders</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Order</span><span class="o">&gt;(</span><span class="n">orders</span><span class="o">);</span>

    <span class="n">Collections</span><span class="o">.</span><span class="na">sort</span><span class="o">(</span><span class="n">processedOrders</span><span class="o">);</span>

    <span class="k">return</span> <span class="n">processedOrders</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p><em>TimeCounter.java:</em></p>

<div class="highlight"><pre><code class="java"><span class="kn">package</span> <span class="n">test</span><span class="o">.</span><span class="na">log</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TimeCounter</span> <span class="o">{</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">start</span><span class="o">;</span>
  <span class="kd">private</span> <span class="kt">long</span> <span class="n">all</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>

  <span class="kd">public</span> <span class="n">TimeCounter</span> <span class="nf">start</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>

    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="n">TimeCounter</span> <span class="nf">stop</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">long</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
    <span class="n">all</span> <span class="o">+=</span> <span class="n">stop</span> <span class="o">-</span> <span class="n">start</span><span class="o">;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="mi">0L</span><span class="o">;</span>

    <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kt">long</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">return</span> <span class="n">all</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>В результате выполнения тестов получилось примерно то, что я ожидал увидеть:<br />
<a href="http://2.bp.blogspot.com/_MzPDIAgS1ow/SZgNGDOH90I/AAAAAAAAJuQ/nB423BfSE70/s1600-h/graph.png"><img src="http://2.bp.blogspot.com/_MzPDIAgS1ow/SZgNGDOH90I/AAAAAAAAJuQ/nB423BfSE70/s400/graph.png" alt="" /></a></p>

<p>На 10M элементов из-за неправильного логирования получается деградация производительности в 185 раз. Так же хочется отметить, что использование фасада <strong>SLF4J</strong> практически не замедляет приложение, но предоставляет очевидные преимущества.  </p>

<p>Надеюсь, что теперь те, кто до этого неправильно использовал логирование не будут повторять свои ошибки, а остальные напомнят себе ещё раз об этом. Ещё раз хочу обратить внимание на относительно новую библиотеку <strong>SLF4J</strong> и советую рассмотреть ее интеграцию с уже существующими системами логирования.</p>



	<div class="post-tags">
		Tags:
		
			<a href="/tags/performance" rel="tag">performance, </a>
		
			<a href="/tags/java" rel="tag">java, </a>
		
			<a href="/tags/logging" rel="tag">logging</a>
		
	</div>
</div>
<div id="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		var disqus_shortname = 'avityuk';
		var disqus_identifier = '/2009/02/blog-post';
		var disqus_url = 'http://avityuk.github.com/2009/02/blog-post.html';
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>


			</div>
			<div id="sidebar">
				<div id="tags">
	<div id="tags-cloud">
		<span style="font-size: 67%"><a href="/tags/appengine/">appengine</a></span>
<span style="font-size: 67%"><a href="/tags/bytecode/">bytecode</a></span>
<span style="font-size: 67%"><a href="/tags/compiler/">compiler</a></span>
<span style="font-size: 67%"><a href="/tags/debugging/">debugging</a></span>
<span style="font-size: 67%"><a href="/tags/error-handling/">error handling</a></span>
<span style="font-size: 67%"><a href="/tags/factory-method/">factory method</a></span>
<span style="font-size: 67%"><a href="/tags/formatting/">formatting</a></span>
<span style="font-size: 67%"><a href="/tags/generics/">generics</a></span>
<span style="font-size: 67%"><a href="/tags/google/">google</a></span>
<span style="font-size: 474%"><a href="/tags/java/">java</a></span>
<span style="font-size: 67%"><a href="/tags/jdbc/">jdbc</a></span>
<span style="font-size: 135%"><a href="/tags/logging/">logging</a></span>
<span style="font-size: 67%"><a href="/tags/mock/">mock</a></span>
<span style="font-size: 67%"><a href="/tags/multithreading/">multithreading</a></span>
<span style="font-size: 135%"><a href="/tags/pattern/">pattern</a></span>
<span style="font-size: 67%"><a href="/tags/performance/">performance</a></span>
<span style="font-size: 135%"><a href="/tags/reflection/">reflection</a></span>
<span style="font-size: 67%"><a href="/tags/sbt/">sbt</a></span>
<span style="font-size: 135%"><a href="/tags/scala/">scala</a></span>
<span style="font-size: 67%"><a href="/tags/testing/">testing</a></span>
<span style="font-size: 67%"><a href="/tags/web/">web</a></span>

	</div>
</div>

			</div>
			<div style="clear: both;"></div>
		</div>
	</div>

	<div id="footer-wrapper">
		<div id="footer">
			Copyright &copy; 2011 All Rights Reserved.
		</div>
	</div>
</body>
</html>
